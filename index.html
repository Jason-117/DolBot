<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户访问数据</title>
    <style>
        body { font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; margin: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 950px; margin: 0 auto; display: none;}
        h1 { color: #1a73e8; text-align: center; margin-bottom: 30px; }
        
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f0f2f5; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box {
            background: #fff; padding: 30px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center;
        }
        .login-box h2 { margin-top: 0; color: #1a73e8; }
        .login-box input {
            width: 200px; padding: 12px; border: 1px solid #ddd;
            border-radius: 8px; margin-bottom: 15px; outline: none; text-align: center;
        }
        .login-box button {
            background: #1a73e8; color: #fff; border: none;
            padding: 10px 25px; border-radius: 8px; cursor: pointer;
        }
        .login-box button:hover { background: #1557b0; }
        .error-msg { color: #d93025; font-size: 14px; margin-top: 10px; display: none; }

        .controls {
            display: grid; grid-template-columns: 2fr 1.2fr 1.2fr 1fr auto;
            gap: 12px; margin-bottom: 20px; background: #fff;
            padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            align-items: end;
        }
        .control-item label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; box-sizing: border-box; }
        .reset-btn { background-color: #f1f3f4; color: #5f6368; border: 1px solid #dadce0; padding: 10px 20px; border-radius: 8px; cursor: pointer; }

        #user-list { display: flex; flex-direction: column; gap: 12px; }
        .user-card {
            background: #fff; padding: 16px; border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex;
            justify-content: space-between; align-items: center;
        }
        .user-info .name { font-size: 16px; font-weight: bold; }
        .username-link { font-size: 13px; color: #25d366; text-decoration: none; background: #e8faf0; padding: 2px 8px; border-radius: 4px; }
        .user-meta { text-align: right; }
        .loading, .no-results { text-align: center; padding: 40px; color: #666; }

        @media (max-width: 850px) { .controls { grid-template-columns: 1fr 1fr; } .reset-btn { grid-column: span 2; } }
        @media (max-width: 480px) { .controls { grid-template-columns: 1fr; } .reset-btn { grid-column: span 1; } }
    </style>
</head>
<body>

<div class="container" id="mainContainer">
    <h1>访问用户列表</h1>

    <div class="controls">
        <div class="control-item">
            <label>搜索姓名/用户名</label>
            <input type="text" id="searchInput" placeholder="关键词..." oninput="filterAndSort()">
        </div>
        <div class="control-item">
            <label>开始日期</label>
            <input type="date" id="startDate" onchange="filterAndSort()">
        </div>
        <div class="control-item">
            <label>结束日期</label>
            <input type="date" id="endDate" onchange="filterAndSort()">
        </div>
        <div class="control-item">
            <label>排序方式</label>
            <select id="sortOrder" onchange="filterAndSort()">
                <option value="desc">最新优先</option>
                <option value="asc">最早优先</option>
            </select>
        </div>
        <button class="reset-btn" onclick="resetFilters()">重置</button>
    </div>

    <div id="user-list">
        <p class="loading">正在获取用户数据...</p>
    </div>
</div>

<script>
    let userData = [];

    async function loadUsers() {
        const listDiv = document.getElementById('user-list');
        const mainContainer = document.getElementById('mainContainer');
        const accessDenied = document.getElementById('access-denied');

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            accessDenied.style.display = 'flex';
            return;
        }

        try {
            const response = await fetch('https://jason-117-dolphinbot-91.deno.dev/users', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.status === 401) {
                throw new Error('身份校验失败：Token 无效');
            }
            if (!response.ok) throw new Error('服务器响应错误');

            userData = await response.json();
            
            mainContainer.style.display = 'block';
            filterAndSort();

        } catch (err) {
            console.error(err);
            accessDenied.style.display = 'flex';
            accessDenied.querySelector('p').innerText = err.message;
        }
    }

    // 初始化加载
    document.addEventListener('DOMContentLoaded', loadUsers);

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('sortOrder').value = 'desc';
        filterAndSort();
    }

    function filterAndSort() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const startStr = document.getElementById('startDate').value;
        const endStr = document.getElementById('endDate').value;
        const order = document.getElementById('sortOrder').value;
        const listDiv = document.getElementById('user-list');

        const startTime = startStr ? new Date(startStr + 'T00:00:00').getTime() : null;
        const endTime = endStr ? new Date(endStr + 'T23:59:59').getTime() : null;

        let result = userData.filter(user => {
            const fullName = `${user.firstName || ''}${user.lastName || ''}`.toLowerCase();
            const username = (user.username || '').toLowerCase();
            const matchesQuery = fullName.includes(query) || username.includes(query);

            let matchesRange = true;
            if (user.lastInteraction) {
                const userTime = new Date(user.lastInteraction).getTime();
                if (startTime && userTime < startTime) matchesRange = false;
                if (endTime && userTime > endTime) matchesRange = false;
            } else if (startTime || endTime) {
                matchesRange = false;
            }
            return matchesQuery && matchesRange;
        });

        result.sort((a, b) => {
            const dateA = new Date(a.lastInteraction || 0).getTime();
            const dateB = new Date(b.lastInteraction || 0).getTime();
            return order === 'desc' ? dateB - dateA : dateA - dateB;
        });

        if (result.length === 0) {
            listDiv.innerHTML = '<p class="no-results">未找到匹配记录</p>';
            return;
        }

        listDiv.innerHTML = result.map(user => {
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || '未知用户';
            const username = user.username;
            const timeStr = user.lastInteraction ? new Date(user.lastInteraction).toLocaleString('zh-CN', { hour12: false }) : '无记录';
            const usernameDisplay = username 
                ? `<a href="https://t.me/${username}" target="_blank" class="username-link">@${username}</a>`
                : `<span class="username-text">无用户名</span>`;

            return `
                <div class="user-card">
                    <div class="user-info">
                        <div class="name">${fullName}</div>
                        <div class="username">${usernameDisplay}</div>
                    </div>
                    <div class="user-meta">
                        <div class="time-label">最后活跃</div>
                        <div class="time-value">${timeStr}</div>
                    </div>
                </div>
            `;
        }).join('');
    }
</script>

</body>
</html>